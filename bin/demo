#!/usr/bin/env node

/**
 * Constraint Monitor Demo Script
 * Demonstrates the complete dashboard and status line system
 */

import { DashboardServer } from '../src/dashboard-server.js';
import { exec } from 'child_process';
import { promisify } from 'util';

const execAsync = promisify(exec);

console.log('ğŸ›¡ï¸  CONSTRAINT MONITOR DEMO');
console.log('â•'.repeat(50));

console.log('\nğŸ“± 1. Status Line Output:');
console.log('â”€'.repeat(30));

try {
    const { stdout } = await execAsync('node src/status/constraint-status-line.js');
    const statusData = JSON.parse(stdout);
    
    console.log(`Text: ${statusData.text}`);
    console.log(`Color: ${statusData.color}`);
    console.log(`Click Action: ${statusData.onClick}`);
    console.log('\nTooltip Preview:');
    console.log('â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”');
    statusData.tooltip.split('\n').forEach(line => {
        console.log(`â”‚ ${line.padEnd(27)} â”‚`);
    });
    console.log('â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜');
    
} catch (error) {
    console.error('âŒ Failed to get status line:', error.message);
}

console.log('\nğŸŒ 2. Dashboard Server:');
console.log('â”€'.repeat(30));

try {
    // Start dashboard server
    const server = new DashboardServer(3001);
    await server.start();
    
    console.log('âœ… Dashboard server started');
    console.log('ğŸ”— URL: http://localhost:3001/dashboard');
    console.log('ğŸ› ï¸  API: http://localhost:3001/api');
    
    // Test API endpoints
    console.log('\nğŸ“Š 3. API Endpoints Test:');
    console.log('â”€'.repeat(30));
    
    const { default: fetch } = await import('node-fetch');
    
    // Test health endpoint
    const healthResponse = await fetch('http://localhost:3001/api/health');
    const health = await healthResponse.json();
    console.log(`âœ… Health: ${health.data.status}`);
    
    // Test status endpoint
    const statusResponse = await fetch('http://localhost:3001/api/status');
    const status = await statusResponse.json();
    console.log(`ğŸ“Š Compliance: ${status.data.compliance_score}`);
    console.log(`âš ï¸  Violations: ${status.data.active_violations}`);
    
    // Test constraints endpoint
    const constraintsResponse = await fetch('http://localhost:3001/api/constraints');
    const constraints = await constraintsResponse.json();
    console.log(`ğŸ“‹ Constraints: ${constraints.data.length} rules loaded`);
    
    console.log('\nğŸ‰ Demo Complete!');
    console.log('â•'.repeat(50));
    console.log('ğŸ–±ï¸  Dashboard is now running at: http://localhost:3001/dashboard');
    console.log('âŒ¨ï¸  Press Ctrl+C to stop the demo server');
    
    // Keep server running
    process.on('SIGINT', async () => {
        console.log('\nğŸ›‘ Shutting down demo server...');
        await server.stop();
        console.log('âœ… Demo complete!');
        process.exit(0);
    });
    
} catch (error) {
    console.error('âŒ Demo failed:', error.message);
    process.exit(1);
}